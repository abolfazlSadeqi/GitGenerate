@using Core
@model List<GitFlowBranch>
@{
    ViewData["Title"] = "GitFlow Dashboard";
    string lang = ViewBag.Lang ?? "en";
}

<script src="https://d3js.org/d3.v7.min.js"></script>

<div class="container my-5">
    <!-- جزئیات بالای نمودار -->
    <div id="branch-details" class="mb-3">
        <div class="alert alert-info">@Core.Resources.Resource.ShowDetilesInGitflow.</div>
    </div>

    <h2 class="text-primary fw-bold mb-4">GitFlow Dashboard (@lang.ToUpper())</h2>

    <div id="graph-container" style="width:100%; height:500px; border:1px solid #ddd; border-radius:12px; background:linear-gradient(180deg,#fbfdff,#f3f6fb); padding:12px;"></div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const lang = "@lang";
        const branches = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

        const branchColors = {
            "main": "#28a745",
            "develop": "#007bff",
            "feature": "#fd7e14",
            "release": "#6f42c1",
            "hotfix": "#dc3545",
            "default": "#6c757d"
        };

        const nodes = branches.map(b => ({
            id: b.Name,
            name: b.Display ?? b.Name,
            type: b.Name.includes("feature") ? "feature" :
                  b.Name.includes("release") ? "release" :
                  b.Name.includes("hotfix") ? "hotfix" :
                  b.Name === "develop" ? "develop" :
                  b.Name === "main" ? "main" : "default",
            parent: b.Parent,
            merge: (b.MergeTarget || "").toString(),
            description: (b.Description && b.Description[lang]) ? b.Description[lang] : (b.Description && b.Description["en"]) || "",
            rules: (b.Rules && (b.Rules[lang] || b.Rules["en"])) || [],
            challenges: (b.Challenges && (b.Challenges[lang] || b.Challenges["en"])) || [],
            solutions: (b.Solutions && (b.Solutions[lang] || b.Solutions["en"])) || [],
            notes: (b.Notes && (b.Notes[lang] || b.Notes["en"])) || [],
            bestPractices: (b.BestPractices && (b.BestPractices[lang] || b.BestPractices["en"])) || [],
            mistakes: (b.Mistakes && (b.Mistakes[lang] || b.Mistakes["en"])) || []
        }));

        function resolveMergeTargets(mergeStr) {
            if (!mergeStr) return [];
            const parts = mergeStr.split("&").map(p => p.trim());
            const resolved = new Set();
            parts.forEach(p => {
                if (!p) return;
                const exact = nodes.find(n => n.id === p);
                if (exact) { resolved.add(exact.id); return; }
                if (p.endsWith("/*")) {
                    const prefix = p.replace("/*", "");
                    nodes.forEach(n => { if (n.id.startsWith(prefix)) resolved.add(n.id); });
                    return;
                }
                const lower = p.toLowerCase();
                if (lower.includes("release")) nodes.forEach(n => { if (n.type === "release") resolved.add(n.id); });
                if (lower.includes("develop")) nodes.forEach(n => { if (n.id === "develop") resolved.add(n.id); });
                if (lower.includes("main") || lower.includes("production")) nodes.forEach(n => { if (n.id === "main") resolved.add(n.id); });
                nodes.forEach(n => { if ((n.name || "").toLowerCase().includes(lower)) resolved.add(n.id); });
            });
            return Array.from(resolved);
        }

        const links = [];
        nodes.forEach(n => {
            if (n.parent && n.parent !== "N/A") {
                const p = nodes.find(x => x.id === n.parent);
                if (p) links.push({ source: p.id, target: n.id, type: 'parent' });
            }
            if (n.merge) {
                const resolved = resolveMergeTargets(n.merge);
                resolved.forEach(tid => { if (tid && tid !== n.id) links.push({ source: n.id, target: tid, type: 'merge' }); });
            }
        });

        const container = document.getElementById("graph-container");
        const width = container.clientWidth;
        const height = container.clientHeight;
        const svg = d3.select("#graph-container").append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("cursor","grab");

        const g = svg.append("g");
        svg.call(d3.zoom().scaleExtent([0.3,2.5]).on("zoom", (event)=>{ g.attr("transform", event.transform); }));

        const radius = 50; // شعاع کوچکتر
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d=>d.id).distance(180))
            .force("charge", d3.forceManyBody().strength(-1000))
            .force("center", d3.forceCenter(width/2,height/2))
            .force("collision", d3.forceCollide().radius(radius+10));

        const link = g.append("g").attr("class","links")
            .selectAll("path").data(links).enter()
            .append("path")
            .attr("stroke", d => d.type==='merge'?"#6c757d":"#888")
            .attr("stroke-width", d => d.type==='merge'?2:1.5)
            .attr("fill","none")
            .attr("marker-end","url(#arrow)");

        svg.append("defs").append("marker")
            .attr("id","arrow").attr("viewBox","0 -5 10 10").attr("refX",22).attr("refY",0)
            .attr("markerWidth",7).attr("markerHeight",7).attr("orient","auto")
            .append("path").attr("d","M0,-5L10,0L0,5").attr("fill","#666");

        const nodeG = g.append("g").attr("class","nodes")
            .selectAll("g").data(nodes).enter()
            .append("g")
            .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

        nodeG.append("circle")
            .attr("r", radius)
            .attr("fill", d=>branchColors[d.type]||branchColors.default)
            .attr("stroke","#fff").attr("stroke-width",3)
            .style("filter","drop-shadow(3px 4px 8px rgba(0,0,0,0.2))")
            .on("mouseover", (event,d)=>showTooltip(event,d))
            .on("mouseout", hideTooltip)
            .on("click", (event,d)=>showDetails(d));

        nodeG.append("text")
            .attr("text-anchor","middle").attr("dy","-0.15em").attr("fill","#fff")
            .attr("pointer-events","none").style("font-size","14px").style("font-weight","700")
            .each(function(d){
                const text = d.name||d.id;
                const words = text.split(/\s+/);
                const maxPerLine = 3;
                let line=[], lineIndex=0;
                const lineHeight=16;
                const node = d3.select(this);
                for (let i=0;i<words.length;i++){
                    line.push(words[i]);
                    if (line.length>=maxPerLine || i===words.length-1){
                        node.append("tspan").attr("x",0).attr("dy", lineIndex===0?"0.0em":(lineHeight/14)+"em").text(line.join(" "));
                        line=[]; lineIndex++;
                    }
                }
            });

        const tooltip = d3.select("body").append("div")
            .attr("class","gf-tooltip")
            .style("position","absolute").style("background","#fff")
            .style("border","1px solid rgba(0,0,0,0.08)").style("padding","10px 12px")
            .style("box-shadow","0 6px 18px rgba(0,0,0,0.08)").style("border-radius","8px")
            .style("pointer-events","none").style("opacity",0)
            .style("max-width","320px").style("font-size","13px");

        function showTooltip(event,d){
            const html=`<strong>${escapeHtml(d.name)}</strong>
                <div style="margin-top:6px;color:#333">${escapeHtml(truncate(d.description,260))}</div>
                <div style="margin-top:6px;font-size:12px;color:#666">
                    <span><strong>Parent:</strong> ${escapeHtml(d.parent||"-")}</span><br/>
                    <span><strong>Merge:</strong> ${escapeHtml(d.merge||"-")}</span>
                </div>`;
            tooltip.html(html)
                .style("left",(event.pageX+14)+"px")
                .style("top",(event.pageY-18)+"px")
                .transition().duration(160).style("opacity",1);
        }
        function hideTooltip(){ tooltip.transition().duration(120).style("opacity",0); }

        simulation.on("tick", ()=>{
            link.attr("d", d=>{
                const sx=d.source.x, sy=d.source.y, tx=d.target.x, ty=d.target.y;
                const dx=tx-sx, dy=ty-sy;
                const dr=Math.sqrt(dx*dx+dy*dy)*1.2;
                return `M${sx},${sy}A${dr},${dr} 0 0,1 ${tx},${ty}`;
            });
            nodeG.attr("transform", d=>`translate(${d.x},${d.y})`);
        });

        function dragstarted(event,d){ if(!event.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
        function dragged(event,d){ d.fx=event.x; d.fy=event.y; }
        function dragended(event,d){ if(!event.active) simulation.alphaTarget(0); d.fx=null; d.fy=null; }

        function showDetails(d){
            const safe = arr=>Array.isArray(arr)&&arr.length?arr:null;
            const html=`
                <div class="card p-3 rounded-4 shadow-sm mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="mb-1">${escapeHtml(d.name)}</h4>
                            <div class="text-muted mb-2">${escapeHtml(d.description||"")}</div>
                            <div class="small text-secondary"><strong>Parent:</strong> ${escapeHtml(d.parent||"-")} &nbsp; • &nbsp; <strong>Merge target:</strong> ${escapeHtml(d.merge||"-")}</div>
                        </div>
                        <div>
                            <span class="badge" style="background:${branchColors[d.type]||branchColors.default}; color:#fff; font-weight:600; padding:8px 10px; border-radius:12px;">
                                ${escapeHtml(d.type.toUpperCase())}
                            </span>
                        </div>
                    </div>
                    <div class="mt-3 accordion" id="accordion-${escapeHtmlAttr(d.id)}">
                        ${renderAccordionSection("Rules", safe(d.rules))}
                        ${renderAccordionSection("Challenges", safe(d.challenges))}
                        ${renderAccordionSection("Solutions", safe(d.solutions))}
                        ${renderAccordionSection("Notes", safe(d.notes))}
                    </div>
                </div>
            `;
            document.getElementById("branch-details").innerHTML=html;
        }

        function renderAccordionSection(title,list){
            if(!list) return "";
            const items=list.map(i=>`<li>${escapeHtml(i)}</li>`).join("");
            const id="sec-"+Math.random().toString(36).slice(2,9);
            return `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-${id}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${id}" aria-expanded="false">
                            ${escapeHtml(title)} <span class="ms-2 badge bg-secondary">${list.length}</span>
                        </button>
                    </h2>
                    <div id="${id}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>${items}</ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(str){ if(str===null||str===undefined) return ""; return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
        function escapeHtmlAttr(str){ return escapeHtml(str).replace(/\s+/g,"-"); }
        function truncate(str,len){ if(!str) return ""; return str.length>len?str.slice(0,len-1)+"…":str; }

        const mainNode = nodes.find(n=>n.id==="main");
        if(mainNode){ mainNode.fx=width/2; mainNode.fy=height/2; }

        simulation.alpha(1).restart();
        svg.on("dblclick", ()=>{ nodes.forEach(n=>{ n.fx=null; n.fy=null; }); simulation.alpha(1).restart(); });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
}

<style>
    .gf-tooltip {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .accordion-button {
        font-weight: 600;
    }

    .badge {
        font-size: 13px;
    }
</style>
