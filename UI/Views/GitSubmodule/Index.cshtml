@using Core
@model GitSubmoduleInputModel
@{
    ViewData["Title"] = "Git Submodules";
    string lang = ViewBag.Lang ?? System.Globalization.CultureInfo.CurrentUICulture.Name;
    bool isFa = lang.StartsWith("fa");
}



<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">@(isFa ? "مدیریت Git Submodules" : "Git Submodules Manager")</h1>
        <div>
            <a class="btn btn-outline-secondary me-2" href="/"><i class="bi bi-house"></i> @(isFa ? "خانه" : "Home")
                </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <ul class="nav nav-tabs" id="tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="gen-tab" data-bs-toggle="tab" data-bs-target="#gen" type="button">@(isFa ? "تولید دستورات" : "Generate Commands")</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="doc-tab" data-bs-toggle="tab" data-bs-target="#doc" type="button">@(isFa ? "مستندات و راهنما" : "Documentation & Deep Guide")</button>
                </li>
            </ul>

            <div class="tab-content mt-4">
                <!-- TAB: Generator -->
                <div class="tab-pane fade show active" id="gen" role="tabpanel">
                    <form asp-action="Generate" method="post" class="row g-3">
                        @Html.AntiForgeryToken()

                        <div class="col-md-4">
                            <label class="form-label fw-bold">@(isFa ? "نوع عملیات" : "Operation")</label>
                            <select class="form-select" asp-for="OperationType">
                                <option value="add">@(isFa ? "افزودن (add)" : "Add")</option>
                                <option value="update">@(isFa ? "آپدیت (update)" : "Update")</option>
                                <option value="remove">@(isFa ? "حذف (remove)" : "Remove")</option>
                                <option value="sync">@(isFa ? "همگام‌سازی (sync)" : "Sync")</option>
                                <option value="init">@(isFa ? "شروع (init)" : "Init")</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">@(isFa ? "آدرس مخزن (URL)" : "Repository URL")</label>
                            <input class="form-control" asp-for="RepositoryUrl" placeholder="https://github.com/owner/repo.git" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">@(isFa ? "مسیر محلی (path)" : "Local Path")</label>
                            <input class="form-control" asp-for="LocalPath" placeholder="libs/shared-ui" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">@(isFa ? "رفرنس (شاخه/تگ)" : "Reference (branch/tag)")</label>
                            <input class="form-control" asp-for="Reference" placeholder="main or v1.0.0 or commit-hash" />
                        </div>

                        <div class="col-md-8 d-flex gap-3 align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" asp-for="Recursive" />
                                <label class="form-check-label">@(isFa ? "بارگذاری recursive" : "Recursive")</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" asp-for="AutoCommit" />
                                <label class="form-check-label">@(isFa ? "اتوماتیک commit" : "Auto Commit")</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" asp-for="PushToRemote" />
                                <label class="form-check-label">@(isFa ? "پس از commit، push به remote" : "Push to remote after commit")</label>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">@(isFa ? "پیام commit (اختیاری)" : "Commit message (optional)")</label>
                            <input class="form-control" asp-for="CommitMessage" placeholder="Add submodule ..." />
                        </div>

                        <div class="col-12 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">@(isFa ? "تولید دستورات" : "Generate Commands")</button>
                            <button type="button" class="btn btn-outline-secondary" id="copyBtn">@(isFa ? "کپی دستورات" : "Copy Commands")</button>
                            <button type="button" class="btn btn-outline-info" id="showExampleBtn">@(isFa ? "مثال" : "Show Example")</button>
                        </div>
                    </form>

                    <hr />

                    <div>
                        <h5>@(isFa ? "پیشنهادها و توضیحات" : "Explanation & Tips")</h5>
                        <div class="mb-3">
                            <pre id="explanation" style="white-space:pre-wrap;">@((ViewBag.Output as GitSubmoduleOutput)?.Explanation ?? (isFa ? "هنوز دستوری تولید نشده." : "No commands generated yet."))</pre>
                        </div>

                        <h5>@(isFa ? "دستورات تولید شده" : "Generated Commands")</h5>
                        <div class="mb-3">
                            <pre id="commands" class="bg-light p-3 rounded" style="min-height:120px;white-space:pre-wrap;">@((ViewBag.Output as GitSubmoduleOutput)?.Commands ?? (isFa ? "خالی" : "—"))</pre>
                        </div>
                    </div>

                    <hr />

                    <!-- Conflict helper -->
                    <div class="p-3 bg-white rounded shadow-sm">
                        <h5>@(isFa ? "کمک رفع کانفلیکت" : "Conflict Resolver")</h5>
                        <form asp-action="ResolveConflict" method="post" class="row g-3">
                            @Html.AntiForgeryToken()
                            <div class="col-md-4">
                                <label class="form-label">@(isFa ? "نوع کانفلیکت" : "Conflict type")</label>
                                <select class="form-select" asp-for="ConflictType">
                                    <option value="">@(isFa ? "انتخاب کنید" : "Select")</option>
                                    <option value="detached-head">detached-head</option>
                                    <option value="url-mismatch">url-mismatch</option>
                                    <option value="pointer-mismatch">pointer-mismatch</option>
                                    <option value="modules-dir-missing">modules-dir-missing</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">@(isFa ? "مسیر محلی" : "Local path")</label>
                                <input class="form-control" asp-for="LocalPath" />
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-warning">@(isFa ? "پیشنهاد رفع" : "Suggest Fix")</button>
                            </div>
                        </form>

                        <div class="mt-3">
                            <h6>@(isFa ? "دستورات پیشنهادی" : "Suggested commands")</h6>
                            <pre id="conflictCommands" class="bg-light p-3 rounded" style="white-space:pre-wrap;">@((ViewBag.ConflictOutput as GitSubmoduleOutput)?.Commands ?? (isFa ? "هیچ پیشنهادی هنوز." : "No suggestions yet."))</pre>
                            <div id="conflictExplanation" class="text-muted small">@((ViewBag.ConflictOutput as GitSubmoduleOutput)?.Explanation ?? "")</div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Documentation -->
                <div class="tab-pane fade" id="doc" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <h3>@(isFa ? "راهنمای جامع Git Submodules" : "Deep Guide to Git Submodules")</h3>

                            <section class="mt-3">
                                <h5>@(isFa ? "چیست؟" : "What is it?")</h5>
                                <p>
                                    @(isFa
                                                                        ? "Submodule مکانیزمی در Git است که اجازه می‌دهد یک مخزن را داخل مخزن دیگر به‌عنوان یک dependency قرار دهید. Submodule خودش یک repository جداست و در parent فقط pointer به commit مشخصی نگهداری می‌شود."
                                                                        : "A submodule allows you to keep a Git repository as a subdirectory of another Git repository. The parent stores a reference (pointer) to a specific commit in the submodule.")
                                </p>
                            </section>

                            <section class="mt-3">
                                <h5>@(isFa ? "مزایا و چالش‌ها" : "Benefits & Challenges")</h5>
                                <ul>
                                    <li>@(isFa ? "منظم نگه داشتن وابستگی‌ها" : "Keeps dependencies isolated and tracked by commit")</li>
                                    <li>@(isFa ? "کنترل دقیق نسخه هر dependency" : "Precise control over which commit/version is used")</li>
                                    <li>@(isFa ? "نیاز به مدیریت دستی pointerها و commit کردن آنها در parent" : "Requires manual management of pointers and commits in parent")</li>
                                    <li>@(isFa ? "مواجه شدن با detached HEAD یا mismatch بین .gitmodules و .git/config" : "Potential detached HEAD and URL mismatches between .gitmodules and .git/config")</li>
                                </ul>
                            </section>

                            <section class="mt-3">
                                <h5>@(isFa ? "پاراگراف عملیاتی: شماری از سناریوها" : "Operational recipes & examples")</h5>

                                <h6>@(isFa ? "افزودن submodule" : "Add submodule")</h6>
                                <pre>git submodule add &lt;repo_url&gt; &lt;path&gt;
git submodule update --init --recursive
git add .gitmodules &amp;&amp; git add &lt;path&gt;
git commit -m "Add submodule &lt;path&gt;"</pre>

                                <h6 class="mt-2">@(isFa ? "بروزرسانی به جدیدترین commit در remote" : "Update submodule to remote")</h6>
                                <pre>git submodule update --remote --recursive
git add .
git commit -m "Update submodules"
git push</pre>

                                <h6 class="mt-2">@(isFa ? "حذف کامل submodule" : "Remove submodule completely")</h6>
                                <pre>git submodule deinit -f &lt;path&gt;
git rm -f &lt;path&gt;
rm -rf .git/modules/&lt;path&gt;
git commit -m "Remove submodule &lt;path&gt;"</pre>
                            </section>

                            <section class="mt-3">
                                <h5>@(isFa ? "تفاوت Submodule و Subtree" : "Submodule vs Subtree")</h5>
                                <p>@(isFa ? "Submodule یک reference است، Subtree یک copy که merge می‌شود — Submodule سبک‌تر ولی مدیریت آن پیچیده‌تر است." : "Submodule is a pointer (lightweight) whereas subtree embeds code directly (simpler but duplicates history). Choose based on workflow and release needs.")</p>
                            </section>

                            <section class="mt-3">
                                <h5>@(isFa ? "بهترین روش‌ها (Best Practices)" : "Best Practices")</h5>
                                <ul>
                                    <li>@(isFa ? "برای توسعه فعال از branch مشخصی استفاده کنید و آن را در README مستند کنید." : "Use explicit branches/tags for submodules and document them.")</li>
                                    <li>@(isFa ? "هر تغییر در submodule را در parent با یک commit نقطه‌ای ثبت کنید." : "Always commit pointer changes in the parent repository after changing submodule state.")</li>
                                    <li>@(isFa ? "استفاده از CI برای آپدیت خودکار و چک کردن compatibility." : "Use CI pipelines to verify submodule updates and compatibility.") </li>
                                </ul>
                            </section>

                            <section class="mt-3">
                                <h5>@(isFa ? "رفع کانفلیکت‌ها — نکات عمیق" : "Conflict resolution — deep tips")</h5>
                                <ol>
                                    <li>@Html.Raw(isFa ? "<strong>URL mismatch</strong>: اصلاح .gitmodules سپس `git submodule sync`." : "<strong>URL mismatch</strong>: fix `.gitmodules` then `git submodule sync`.")</li>
                                    <li>@Html.Raw(isFa ? "<strong>Pointer mismatch</strong>: داخل submodule commit/checkout درست را بزنید سپس parent را update کنید." : "<strong>Pointer mismatch</strong>: checkout desired commit in submodule and commit pointer change in parent.")</li>
                                    <li>@Html.Raw(isFa ? "<strong>Detached HEAD</strong>: create a branch or move pointer to a stable commit." : "<strong>Detached HEAD</strong>: create a branch or set pointer to stable commit.")</li>
                                </ol>
                            </section>
                        </div>

                        <div class="col-md-4">
                            <div class="card p-3 mb-3">
                                <h6>@(isFa ? "چک لیست سریع" : "Quick checklist")</h6>
                                <ul class="small">
                                    <li>@(isFa ? "آیا .gitmodules ذخیره شده؟" : "Is `.gitmodules` saved?")</li>
                                    <li>@(isFa ? "آیا pointer در parent commit شده؟" : "Is the pointer committed in parent?")</li>
                                    <li>@(isFa ? "آیا CI برای submodule اجرا شده؟" : "Is CI run for submodule changes?")</li>
                                </ul>
                            </div>

                            <div class="card p-3">
                                <h6>@(isFa ? "مثال سریع" : "Quick example")</h6>
                                <pre>git clone --recurse-submodules ...
git submodule status</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // copy commands button
        document.getElementById('copyBtn')?.addEventListener('click', function(){
            const txt = document.getElementById('commands').innerText;
            if(!txt) return alert('No commands to copy.');
            navigator.clipboard.writeText(txt).then(function(){ alert('@(isFa ? "کپی شد" : "Copied!")'); });
        });

        // show example toggle
        document.getElementById('showExampleBtn')?.addEventListener('click', function(){
            const tab = document.querySelector('#doc');
            // switch to doc tab
            var tabTrigger = new bootstrap.Tab(document.querySelector('#doc-tab'));
            tabTrigger.show();
            // scroll to examples
            setTimeout(()=> {
                const el = document.querySelector('#doc h6');
                if(el) el.scrollIntoView({behavior:'smooth'});
            }, 200);
        });
    </script>

}


<style>
    .hover-card:hover {
        transform: translateY(-4px);
        transition: all 0.2s ease-in-out;
        box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }

    pre {
        font-size: 13px;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
    }
</style>