@using Core
@model List<VersionDetail>

@{
    ViewData["Title"] = "Create New Version";
    string lang = ViewBag.Lang ?? "en";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<div class="container my-5">
    <h2 class="mb-4 text-center">Create New Version</h2>

    <form method="post" action="/versions/new" id="versionForm">
        <!-- Previous Version Inputs -->
        <div class="mb-4">
            <label class="form-label fw-bold">Previous Version</label>
            <div class="d-flex gap-2">
                <input type="number" id="prevMajor" class="form-control" min="0" placeholder="Major" value="1" required />
                <input type="number" id="prevMinor" class="form-control" min="0" placeholder="Minor" value="0" required />
                <input type="number" id="prevPatch" class="form-control" min="0" placeholder="Patch" value="0" required />
            </div>
            <small class="text-muted">Enter the previous version numbers separately</small>
        </div>

        <!-- Change Types with colors and tooltip -->
        <div class="mb-4">
            <label class="form-label fw-bold">Change Type (Select one or more)</label>
            <div class="d-flex gap-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input changeTypeCheckbox" type="checkbox" value="major" id="majorChange" data-bs-toggle="tooltip" data-bs-title="Breaking changes. Resets minor & patch numbers." />
                    <label class="form-check-label badge bg-danger text-white px-3 py-2" for="majorChange">Major</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input changeTypeCheckbox" type="checkbox" value="minor" id="minorChange" data-bs-toggle="tooltip" data-bs-title="New features. Resets patch number." />
                    <label class="form-check-label badge bg-success text-white px-3 py-2" for="minorChange">Minor</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input changeTypeCheckbox" type="checkbox" value="patch" id="patchChange" data-bs-toggle="tooltip" data-bs-title="Bug fixes. Only increments patch number." />
                    <label class="form-check-label badge bg-warning text-dark px-3 py-2" for="patchChange">Patch</label>
                </div>
            </div>
        </div>

        <!-- Pre-release -->
        <div class="mb-4">
            <label for="preRelease" class="form-label fw-bold">Pre-release (Optional)</label>
            <select id="preRelease" name="preRelease" class="form-select">
                <option value="">None</option>
                <option value="alpha">Alpha</option>
                <option value="beta">Beta</option>
                <option value="rc">RC</option>
            </select>
        </div>

        <!-- Description -->
        <div class="mb-4">
            <label for="description" class="form-label fw-bold">Description</label>
            <textarea id="description" name="description" class="form-control" rows="4"></textarea>
        </div>

        <!-- Next Version Preview -->
        <div class="mb-4">
            <label class="form-label fw-bold">Next Version Preview</label>
            <div id="nextVersionPreview" class="form-control form-control-lg fw-bold text-center p-3" style="font-size:1.5rem; background-color:#f8f9fa; border-radius:0.5rem;"></div>
        </div>

        <!-- Hidden input for combined previous version -->
        <input type="hidden" id="previousVersionId" name="previousVersionId" />

    </form>
</div>

<style>
    .form-control-lg {
        font-size: 1.25rem;
    }

    .badge {
        cursor: pointer;
        font-size: 1rem;
    }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const prevMajorInput = document.getElementById('prevMajor');
    const prevMinorInput = document.getElementById('prevMinor');
    const prevPatchInput = document.getElementById('prevPatch');
    const changeTypeCheckboxes = document.querySelectorAll('.changeTypeCheckbox');
    const preReleaseSelect = document.getElementById('preRelease');
    const nextVersionPreview = document.getElementById('nextVersionPreview');
    const previousVersionIdHidden = document.getElementById('previousVersionId');

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    function calculateNextVersion() {
        const major = parseInt(prevMajorInput.value) || 0;
        const minor = parseInt(prevMinorInput.value) || 0;
        const patch = parseInt(prevPatchInput.value) || 0;

        previousVersionIdHidden.value = `${major}.${minor}.${patch}`;

        let newMajor = major;
        let newMinor = minor;
        let newPatch = patch;

        // Get selected change types
        const selectedTypes = Array.from(changeTypeCheckboxes).filter(c => c.checked).map(c => c.value);

        selectedTypes.forEach(type => {
            switch(type) {
                case "major": newMajor++; newMinor = 0; newPatch = 0; break;
                case "minor": newMinor++; newPatch = 0; break;
                case "patch": newPatch++; break;
            }
        });

        let nextVersion = `${newMajor}.${newMinor}.${newPatch}`;
        const pre = preReleaseSelect.value;
        if(pre) nextVersion += `-${pre}`;

        // Color highlight based on change types
        let bgColor = "#f8f9fa"; // default
        if(selectedTypes.includes("major")) bgColor = "#f8d7da"; // redish
        else if(selectedTypes.includes("minor")) bgColor = "#d4edda"; // greenish
        else if(selectedTypes.includes("patch")) bgColor = "#fff3cd"; // yellowish

        nextVersionPreview.style.backgroundColor = bgColor;
        nextVersionPreview.textContent = nextVersion;
    }

    // Event listeners
    [prevMajorInput, prevMinorInput, prevPatchInput].forEach(input => input.addEventListener('input', calculateNextVersion));
    changeTypeCheckboxes.forEach(chk => chk.addEventListener('change', calculateNextVersion));
    preReleaseSelect.addEventListener('change', calculateNextVersion);

    calculateNextVersion();
</script>


}